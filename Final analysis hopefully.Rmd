---
title: "Association between sleep quality and pain in older adults"
author: "Pedro Henrique Brant"
date: "`r Sys.Date()`"
output:
  html_document: 
        toc: true
        toc_depth: 4
        theme: united
  pdf_document: default
---

## Introduction

In this manuscript, we're going to conduct an analysis into the ELSI Dataset. This is a modified version for usage in the Principles and Practice of Clinical Research program of Harvard T.H. Chan School of Public Health.

The aim here is to replicate the analysis done in a [previous paper](https://pubmed.ncbi.nlm.nih.gov/34968438/) and see if the results also apply to the sample that was included in the [ELSI Brazil](https://elsi.cpqrr.fiocruz.br/en/home-english/).

First order of business is to download the dataset we're going to be analyzing, which was kindly provided by PPCR staff.

```{r, message=FALSE, warning=FALSE}
## Loading the necessary libraries
library(tidyverse)
library(haven)
library(broom)
library(ggplot2)
library(gtsummary)
```

```{r}

## Url provided by PPCR staff
url <- 'https://ryver-prd-files.s3.us-west-2.amazonaws.com/tnt45405/T9gKrWnaRr5K0yT/FINAL%20-%20ELSI_students.dta'

## Using the read_dta function from haven to read the .dta file created in STATA
PPCRdata <- read_dta(url)

## Removing the url from memory as it is no longer useful
rm(url)

## Transforming to tibble in order to increase readability
PPCRdata <- as_tibble(PPCRdata)
PPCRdata

```

PPCR Staff has described the variables included in this dataset with the following:
![Variables in modified dataset](https://ryver-prd-files.s3.us-west-2.amazonaws.com/tnt45405/3Rq88vSRw93ITf6/Screen%20Shot%202023-10-04%20at%201.03.35%20PM.png)

### Adjusting Variables for the Analysis

Let's now look at the some of the individual variables to understand what they mean
```{r}
unique(PPCRdata$pain)
unique(PPCRdata$p_intensity)
unique(PPCRdata$sleepquality)
unique(PPCRdata$sleepproblems)
```

We can then see that *pain* and *sleepproblems* are binary variables, while *p_intensity* and *sleepquality* are ordinal variables, although they aren't coded in this manner yet.

Now let's transform *p_intensity* and *sleepquality* into categorical variables and *pain* and *sleepproblems* into dichotomous variables, as they were read as numerical variables with labels.

```{r}
## Using the as_factor function from haven to transform the variables 
## with the labels as names for the levels in the factors
PPCRdata$sleepquality <- as_factor(PPCRdata$sleepquality)
PPCRdata$p_intensity <- as_factor(PPCRdata$p_intensity)
PPCRdata$pain <- as_factor(PPCRdata$pain)
PPCRdata$sleepproblems <- as_factor(PPCRdata$sleepproblems)


levels(PPCRdata$sleepquality)

## Reversing the order of factors, as initially the order was wrong in sleepquality
PPCRdata$sleepquality <- fct_rev(PPCRdata$sleepquality)
levels(PPCRdata$sleepquality)

## doing the same with genhealth as it will be used for a sensitivity analysis
# adjusting the genhealth variable
PPCRdata %>% mutate(genhealth = fct_rev(as_factor(genhealth))) -> PPCRdata
```

Other variables that we're going to use in our model that haven't been coded properly as well include: *depression*, *alcohol*, *fracture*, *cancer*, *diabetes*, *dementia*, *arthritis*, *heartdisease* and *lungdisease*.

```{r}
## Showing that the variables are coded as numerical variables
unique(PPCRdata$depression)

## Commented the other variables for brevity, but they were all numerical
## unique(PPCRdata$sex)
## unique(PPCRdata$alcohol)
## unique(PPCRdata$fracture)
## unique(PPCRdata$cancer)
## unique(PPCRdata$diabetes)
## unique(PPCRdata$dementia)
## unique(PPCRdata$arthritis)
## unique(PPCRdata$heartdisease)
## unique(PPCRdata$lungdisease)

## Using the as_factor function from haven to transform the variables 
## with the labels as names for the levels in the factors
PPCRdata$depression <- as_factor(PPCRdata$depression)
PPCRdata$sex <- as_factor(PPCRdata$sex)
PPCRdata$alcohol <- as_factor(PPCRdata$alcohol)
PPCRdata$fracture <- as_factor(PPCRdata$fracture)
PPCRdata$cancer <- as_factor(PPCRdata$cancer)
PPCRdata$diabetes <- as_factor(PPCRdata$diabetes)
PPCRdata$dementia <- as_factor(PPCRdata$dementia)
PPCRdata$arthritis <- as_factor(PPCRdata$arthritis)
PPCRdata$heartdisease <- as_factor(PPCRdata$heartdisease)
PPCRdata$lungdisease <- as_factor(PPCRdata$lungdisease)

## Converting age to numeric

PPCRdata$age <- as.numeric(PPCRdata$age)
```
Let's now create a table summarizing all the information we have collected.

```{r, fig.width = 10}
## Table 1
## divided by pain

## selecting all the variables that will be used
PPCRdata %>% dplyr::select(age,bmi,sex,pain,p_intensity,sleepquality,
                           sleepproblems,depression,alcohol,fracture,cancer,
                           diabetes,dementia,arthritis,heartdisease,
                           lungdisease) %>%
        
        ## recoding the variables to not have levels that aren't used, so
        ## that they don't clutter the table
        mutate(pain = recode(droplevels(pain), No = "No Pain", Yes = "Pain"),
               p_intensity = droplevels(p_intensity),
               sleepquality = droplevels(sleepquality),
               depression = droplevels(depression),
               alcohol = droplevels(alcohol),
               diabetes = droplevels(diabetes),
               dementia = droplevels(dementia),
               arthritis = droplevels(arthritis),
               cancer = droplevels(cancer),
               sleepproblems = droplevels(sleepproblems)) %>%
        
        ## determining how each type of variable will be presented
        ## continous as mean and sd and categorical as absolute relative
        ## frequencies
        tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})",
                                    all_categorical() ~ "{n} ({p}%)"),
                    ## not showing NA's in each variable
                    missing = "no",
                    ## dividing the observations by pain
                    by = pain,
                    ## presenting the variables better
                    label = list(p_intensity ~ "Pain Intensity",
                                 sleepquality ~ "Sleep Quality",
                                 depression ~ "Depression",
                                 alcohol ~ "Alcohol Consumption",
                                 diabetes ~ "Diabetes Mellitus",
                                 dementia ~ "Dementia",
                                 arthritis ~ "Arthritis",
                                 cancer ~ "Cancer",
                                 sleepproblems ~ "Sleep Problems",
                                 age ~ "Age",
                                 bmi ~ "Body Mass Index",
                                 fracture ~ "Fracture of Hip or Wrist",
                                 heartdisease ~ "Heart Disease",
                                 lungdisease ~ "Lung Disease")) %>%
                ## title of the variable column
                modify_header(label = "**Variable**") %>%
                ## title of the table
                modify_caption("Subjects baseline characteristics") %>%
                bold_labels() %>%
                ## since we're not showing NA's in each variable, showing the
                ## N for each specific variable
                add_n() %>% 
                ## adding a column for overall observations, not divided by pain
                add_overall(last = TRUE) -> table1

## checking if table has been saved already
if (!file.exists("C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/tables/table1.docx")){
        ## if it hasn't, saving the table for publication
        table1 %>% 
                as_gt() %>% 
                gt::gtsave(filename = "table1.docx", path = "C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/tables")
}
## printing the table
table1
```
It's important to note that the pain intensity variable doesn't have any observations for those that do not have pain in the first place, as should be expected. 

At this point we have coded all the variables correctly, so we can proceed with the analysis.

## Analysis
### Association between *pain* and *sleepquality*
#### Unadjusted Analysis
This analysis checks for the association between the *pain* variable and the *sleepquality* variable, without adjustments. As *pain* is a binary variable, we're going to run a logistic regression.

```{r warning=FALSE}
## using the generalized linear model function 
## with the family = "binomial" to create a logistical
## regression

model1 <- glm (data = PPCRdata, formula = pain ~ sleepquality,
               family = "binomial")
summary(model1)

## coef(model1) extracts the coefficients from the model
## confint(model1) calculates confidence intervals (95%)
## cbind then creates a table by joining the two by column
## finally, we exponentiate all the results using the base e
## in order to transform logit units into regular units

exp(cbind(OR = coef(model1),confint(model1)))

## another way, which is simpler and does the same, is to use
## the broom::tidy function

model1Tidy <- tidy(model1, conf.int = TRUE, exponentiate = TRUE)
model1Tidy %>% rename(Odds.Ratio = estimate) -> model1Tidy
model1Tidy

## as we will be doing this extensively for each model, creating a function
## in order to not repeat the code every time
tbl_pub <- function(model, path, file, labels){
        model %>% 
                        tbl_regression(exponentiate = TRUE, conf.int = TRUE, 
                                       label = labels) %>% 
                        bold_p() %>%
                        bold_labels() %>%
                        italicize_levels() %>%
                        modify_header(label = "**Variable**") -> tblx
        ## checking if the model has been saved already
        if (!file.exists(paste(path,file,sep = ""))){
                ## if it hasn't, saving the model for publication
                tblx %>%
                        as_gt() %>% 
                        gt::gtsave(filename = file, path = path)   
        }
        tblx
}

## creating a label list
labelList <- list(sleepquality ~ "Sleep Quality",
                  pain ~ "Pain",
                  age ~ "Age",
                  bmi ~ "Body Mass Index",
                  depression ~ "Depression",
                  alcohol ~ "Alcohol",
                  fracture ~ "Fracture",
                  cancer ~ "Cancer",
                  diabetes ~ "Diabetes",
                  dementia ~ "Dementia",
                  arthritis ~ "Arthritis",
                  heartdisease ~ "Heart Disease",
                  lungdisease ~ "Lung Disease",
                  sex ~ "Sex")

## creating a path variable

tablePath <- "C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/tables/"

## creating and saving the publication table
tbl_pub (model1, tablePath, "model1.docx", labelList[1]) -> tbl1


## let's plot these coefficients and their CI's to increase
## readability

## setting up two label arrays for reuse later

labels1 <- c("sleepqualityVery good" = "Very Good", "sleepqualityGood" = "Good",
             "sleepqualityFair" = "Fair", "sleepqualityBad" = "Bad")

labels2 <-c("sleepqualityVery good" = "Sleep Quality: Very Good",
            "sleepqualityGood" = "Sleep Quality: Good",
            "sleepqualityFair" = "Sleep Quality: Fair",
            "sleepqualityBad" = "Sleep Quality: Bad",
            "sleepqualityVery Bad" = "Reference - Sleep Quality: Very Bad",
            "alcoholOnce a month or more" = "Alcohol Use: Once a month of more",
            "alcoholLess than once a month" = "Alcohol Use: Less than once a month",
            "alcoholNever" = "Reference - Alcohol Use: Never",
            "depressionYes" = "Depression",
            "alcoholYes" = "Alcohol Consumption",
            "diabetesYes" = "Diabetes Mellitus",
            "dementiaYes" = "Dementia",
            "arthritisYes" = "Arthritis",
            "cancerYes" = "Cancer",
            "age" = "Age",
            "bmi" = "Body Mass Index",
            "fractureYes" = "Fracture of Hip or Wrist",
            "heartdiseaseYes" = "Heart Disease",
            "lungdiseaseYes" = "Lung Disease",
            "painYes" = "Pain",
            "sexMale" = "Male")

## creating a plot

model1Tidy %>% ggplot (aes(Odds.Ratio, term, xmin = conf.low,
                           xmax = conf.high, height = 0)) +
                ## inserting a point for the odds ratio
                geom_point() +
                ## drawing a line at the 1 to improve readability
                geom_vline(xintercept = 1, lty = 4) +
                ## drawing an horizontal line to represent the 
                ## confidence interval
                geom_errorbarh() +
                ## removing the intercept term and changing labels
                scale_y_discrete(
                        limits = setdiff(model1Tidy$term, "(Intercept)"),
                        labels = labels1) +
                labs(x = "Odds Ratio", y = "Sleep Quality",
                     title = "Presence of Pain", 
                subtitle = "Unadjusted odds ratio, in comparison to \"Very Bad\" Sleep Quality",
                caption = paste("N =", nobs(model1))) +
                ## adjusting the ticks on the x axis and its range
                scale_x_continuous (breaks = seq(0,1.2,0.2),
                                    limits = c(0,1.2)) -> plot1
## checking if plot has been saved already
if (!file.exists("C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots/plot1.png")){
        ## if it hasn't, saving the plot for publication
        ggsave("plot1.png", plot1, 
               path = "C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots", height = 3) 
}

plot1
```

This analysis allows us to determine that, when using a reference level of *sleepquality* that is **very bad**, the odds of experiencing *pain* when *sleepquality* increases are significantly lower (the odds ratio of the comparison of each other level with the very bad level of sleep quality can be seen in the table and plot above).

---

##### Sensitivity Analysis

In this next model, we're going to consider sleepquality as a continuous variable.

```{r}
## doing the transformation and saving on another variable to not lose the
## categorical information (names for each level)
PPCRdata %>% mutate(sleepqualitynum = 
        case_when(PPCRdata$sleepquality == 'Very bad' ~ 1,
                  PPCRdata$sleepquality == 'Bad' ~ 2,
                  PPCRdata$sleepquality == 'Fair' ~ 3,
                  PPCRdata$sleepquality == 'Good' ~ 4,
                  PPCRdata$sleepquality == 'Very good' ~ 5)) -> PPCRdata
```

Now that the variable is transformed to numeric, let's run the model again.

```{r, warning = FALSE}

glm (data = PPCRdata, formula = pain ~ sleepqualitynum, 
     family = "binomial") -> model2
model2 %>% tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
        rename(Odds.Ratio = estimate) -> model2Tidy
model2Tidy

model2Tidy %>% ggplot (aes(Odds.Ratio, term, xmin = conf.low,
                           xmax = conf.high, height = 0)) +
                ## inserting a point for the odds ratio
                geom_point() +
                ## drawing a line at the 1 to improve readability
                geom_vline(xintercept = 1, lty = 4) +
                ## drawing an horizontal line to represent the 
                ## confidence interval
                geom_errorbarh() +
                scale_y_discrete(
                        limits = setdiff(model2Tidy$term, "(Intercept)"))

```

In order to determine which model is best, we're going to look at the AIC values. It looks like changing the variable to continues increases the AIC, which tells us that the model is behaving worse than the categorical. Let's keep it categorical, then.

---

#### Adjusted Analysis
This analysis checks for the association between the *pain* variable and the *sleepquality* variable, adjusting the model for bmi, comorbidities and depression, as was done in the original article. As *pain* is a binary variable, we're going to run a logistic regression.

```{r}
model3 <- glm(data = PPCRdata, formula = pain ~ sleepquality + age + bmi + 
                      depression + alcohol + fracture + cancer + diabetes + 
                      dementia + arthritis + heartdisease + lungdisease,
                family = "binomial")
summary(model3)

## creating and saving publication-ready table
tbl_pub (model3, tablePath, "model3.docx", labelList[-c(2,14)]) -> tbl3

tbl_merge(list(tbl1,tbl3),
          tab_spanner = c("**Unadjusted**", "**Adjusted**")) -> merged1

if(!file.exists(paste(tablePath,"merged1.docx", sep=""))){
        merged1 %>% as_gt() %>% gt::gtsave(filename = "merged1.docx", path = tablePath)
}
```
Let's adjust the results and plot the odds ratios.

```{r, warning = FALSE}

model3Tidy <- tidy(model3, conf.int = TRUE, exponentiate = TRUE)
model3Tidy %>% rename(Odds.Ratio = estimate) -> model3Tidy
model3Tidy

## adding the reference terms to the data frame to allow for a better plot
model3Tidy %>% add_row(term = "sleepqualityVery Bad", Odds.Ratio = -99, std.error = 0, statistic = 0, p.value = 0, conf.low = 0, conf.high = 0, .before = 2) %>%
        add_row(term = "alcoholNever", Odds.Ratio = -99, std.error = 0, statistic = 0, p.value = 0, conf.low = 0, conf.high = 0, .before = 10) %>%
        ## filtering the intercept
        filter (term !="(Intercept)") %>%
        ## saving the result so that we can refer to it in the next call
        {. ->> model3Tidy}%>%
        ## adding a variable to determine whether the observation
        ## is a reference or not. Initially adding everything as FALSE
        add_column(.after = "conf.high",
                   reference = rep(FALSE, length.out = nrow(model3Tidy))) %>%
        ## now the appropriate ones to TRUE
        dplyr::mutate(reference = case_when
               (term %in% c("Very Bad", "Never") ~ TRUE,
                                     TRUE ~ FALSE)) %>%
        ## create a Variable column
        dplyr::mutate(.after= "term",
                      Variable = case_when(grepl("sleep", term) ~ "Sleep Quality",
                                           grepl("age", term) ~ "Age",
                                           grepl("bmi", term) ~ "Body Mass Index",
                                           grepl("depression",term) ~ "Depression",
                                           grepl("alcohol",term) ~ "Alcohol",
                                           grepl("fracture", term) ~ "Fracture",
                                           grepl("cancer",term) ~ "Cancer",
                                           grepl("diabetes",term) ~ "Diabetes",
                                           grepl("dementia", term) ~ "Dementia",
                                           grepl("arthritis",term) ~ "Arthritis",
                                           grepl("heart",term) ~ "Heart Disease",
                                           grepl("lung",term) ~ "Lung Disease")) %>%
        ## transform the variables to factor
        dplyr::mutate(Variable = as_factor(Variable)) %>%
        dplyr::mutate(term = as_factor(term)) -> model3Tidy


model3Tidy %>% ggplot (aes(x = Odds.Ratio, y = term, xmin = conf.low,
                           xmax = conf.high, height = 0, alpha = !reference)) +
                ## inserting a point for the odds ratio
                geom_point(aes(alpha = !reference)) +
                ## drawing a line at the 1 to improve readability
                geom_vline(xintercept = 1, lty = 4) +
                ## drawing an horizontal line to represent the 
                ## confidence interval
                geom_errorbarh() +
                scale_y_discrete(labels = labels2) +
                labs(x = "Odds Ratio", y = "",
                     title = "Presence of Pain", 
                subtitle = "Adjusted Odds Ratios",
                caption = paste("N =", nobs(model3))) +
                facet_grid(Variable ~ ., scales = "free_y", space = "free_y") +
                scale_alpha_identity() +
                # hide facet labels
                theme(strip.background = element_blank(),
                strip.text = element_blank()) +
                # remove spacing between facets
                theme(panel.spacing = unit(0, "pt")) +
                scale_x_continuous(breaks = seq(0,3, by = 0.5),
                                   limits = (c(0,2.9))) -> plot3

## checking if plot has been saved already
if (!file.exists("C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots/plot3.png")){
        ## if it hasn't, saving the plot for publication
        ggsave("plot3.png", plot3, 
               path = "C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots") 
}

plot3

```

If we refer to the analysis of the unadjusted model, the results are the same for the *sleepquality* variable. In summary, increasing levels of sleep quality are decrease the odds of pain being present.

##### Sensitivity Analysis

We can also test how the adjusted model behaves with sleep quality as a continuous variable.

```{r, warning = FALSE}

model4 <- glm(data = PPCRdata, formula = pain ~ sleepqualitynum + age + bmi + 
                      depression + alcohol + fracture + cancer + diabetes + 
                      dementia + arthritis + heartdisease + lungdisease,
                family = "binomial")
summary(model4)

model4Tidy <- tidy(model4, conf.int = TRUE, exponentiate = TRUE)
model4Tidy %>% rename(Odds.Ratio = estimate) -> model4Tidy
model4Tidy

model4Tidy %>% ggplot (aes(Odds.Ratio, term, xmin = conf.low,
                           xmax = conf.high, height = 0)) +
                ## inserting a point for the odds ratio
                geom_point() +
                ## drawing a line at the 1 to improve readability
                geom_vline(xintercept = 1, lty = 4) +
                ## drawing an horizontal line to represent the 
                ## confidence interval
                geom_errorbarh() +
                scale_y_discrete(
                        limits = setdiff(model4Tidy$term, "(Intercept)"))

```

The results point towards increases in the continuous variable also being significantly associated with a decrease in the odds of pain being present. Looking at the AIC, it still seems as if the model with sleepquality coded as categorical behaves better.

#### Testing the assumptions of the model

At this point, I haven't yet learned how to properly test for the assumptions of the logistic regression model. On a later opportunity, I'll try to remedy this situation. For now, I'll include some commands that were listed as useful in the [R you ready for R?](https://bookdown.org/wadetroberts/r-you-ready-for-r/multiple-logistic-regression.html#model-fit-statistics-for-multiple-logistic-regression) e-book. 

```{r warning= FALSE}
library(blorr)
blr_model_fit_stats(model3)
blr_test_hosmer_lemeshow(model3)
blr_roc_curve(blr_gains_table(model3))
car::vif(model3)
```

### Association between *sleepquality* and *pain*
#### Ordinal Regression
##### Adjusted Analysis
In order to do this analysis I'll try to follow the instructions from the [UCLA OARC - Ordinal Logistic Regression | R Data Analysis Example](https://stats.oarc.ucla.edu/r/dae/ordinal-logistic-regression/).

As the original article by [Montelhão et al](https://pubmed.ncbi.nlm.nih.gov/34968438/) tested for bidirectional associations, let's try to replicate that as well. In this case, the dependent variable is ordinal, therefore we will run an ordinal logistical regression.

```{r warning = FALSE, message = FALSE}
## creating an ordinal version of sleepquality

PPCRdata %>% mutate (sleepqualityord = factor(PPCRdata$sleepquality,
                                              ordered = TRUE)) -> PPCRdata

## loading the library required to run the model
library(MASS)

## running the model
model5 <- polr (data = PPCRdata, formula = sleepqualityord ~ pain + depression + 
                       alcohol + fracture + cancer + diabetes + dementia +
                       arthritis + heartdisease + lungdisease, Hess = TRUE)
summary(model5)
```

```{r}
## tidy(model5, exponentiate = TRUE, p.values = TRUE, conf.int = TRUE)
```

The tidy function is not working for the polr model, even though it should. I tried to debug it, but couldn't. I will then describe a more manual approach, as was described in the [UCLA Office of Advanced Research Computing (OARC)](https://stats.oarc.ucla.edu/r/dae/ordinal-logistic-regression/) page for Ordinal Regression.


```{r}
## getting the coefficients
ctable <- coef(summary(model5))

## getting the respective p-values from the normal distribution
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2

## creating a table with the respective p-values added
ctable <- cbind(ctable, "p value" = p)
ctable

## creating confidence intervals
ci<-confint.default(model5)
colnames(ci) <- c("conf.low", "conf.high")

## exponentiating the log-odds and the confidence intervals
## in order to create the odds-ratios and the respective CI's
model5OddsRatio <- exp(cbind(OR = coef(model5), ci))
## converting rownames to columns, as this will be necessary to build the plot
model5OddsRatio <- as_tibble(rownames_to_column(as.data.frame(model5OddsRatio)))
model5OddsRatio %>% rename(term = rowname) -> model5OddsRatio

```
Let's build a plot using these values.

```{r}
model5OddsRatio %>% ggplot (aes(OR, term, xmin = conf.low,
                           xmax = conf.high, height = 0)) +
                geom_point() +
                geom_vline(xintercept = 1, lty = 4) +
                geom_errorbarh()
```

The plot allows us to visually determine that the presence of *pain* decreases the odds of *sleepquality* being higher. Unfortunately, the model has a high AIC.

##### Unadjusted Analysis

In order to be able to compare the adjusted analysis, let's proceed with one that is unadjusted as well.

```{r}
## this code is equivalent to the one used for the adjusted analysis, just 
## with no covariates added to the model
model6 <- polr (data = PPCRdata, formula = sleepqualityord ~ pain, Hess = TRUE)
summary(model6)

## getting the coefficients
ctable2 <- coef(summary(model6))

## getting the respective p-values from the normal distribution
p <- pnorm(abs(ctable2[, "t value"]), lower.tail = FALSE) * 2

## creating a table with the respective p-values added
ctable2 <- cbind(ctable2, "p value" = p)

## creating confidence intervals
ci<-confint.default(model6)
colnames(ci) <- c("conf.low", "conf.high")

## exponentiating the log-odds and the confidence intervals
## in order to create the odds-ratios and the respective CI's
model6OddsRatio <- exp(cbind(OR = coef(model6), ci))
## converting rownames to columns, as this will be necessary to build the plot
model6OddsRatio <- as_tibble(rownames_to_column(as.data.frame(model6OddsRatio)))
model6OddsRatio %>% rename(term = rowname) -> model6OddsRatio
model6OddsRatio

## building a plot
model6OddsRatio %>% ggplot (aes(OR, term, xmin = conf.low,
                           xmax = conf.high, height = 0)) +
                geom_point() +
                geom_vline(xintercept = 1, lty = 4) +
                geom_errorbarh()
```

We need to check what the warning means, but the presence of pain reduces the odds of increased sleep quality in this model. The AIC is huge, as should be expected of a model that only has one predictor and that predictor is a dichotomous variable.

##### Testing for the Proportional Odds Assumption

This is something to consider further on. At this point, I haven't yet figured out exactly how to do it, but I'll try to follow the instructions from the [Office of Advanced Research Computing](https://stats.oarc.ucla.edu/r/dae/ordinal-logistic-regression/) on another day.

```{r, messages = FALSE, warning = FALSE}
## Loading the library that is needed to conduct the visual analysis of the
## proportional odds assumption

library (Hmisc)

sf <- function(y) {
  c('Y>=1' = qlogis(mean(y >= 1)),
    'Y>=2' = qlogis(mean(y >= 2)),
    'Y>=3' = qlogis(mean(y >= 3)),
    'Y>=4' = qlogis(mean(y >= 4)),
    'Y>=5' = qlogis(mean(y >= 5)),
    'Y>=6' = qlogis(mean(y >= 6)))
}

(s <- with(PPCRdata, summary(as.numeric(sleepqualityord) ~ pain + depression + 
                       alcohol + fracture + cancer + diabetes + dementia +
                       arthritis + heartdisease + lungdisease, fun=sf)))

s[, 6] <- s[, 6] - s[, 5]
s[, 5] <- s[, 5] - s[, 4]
s[, 4] <- s[, 4] - s[, 3]
s[, 3] <- s[, 3] - s[, 3]

s

plot(s, which=1:6, xlab='logit', main=' ', xlim=c(-2.8,0))

```

It doesn't look like the proportional odds assumption holds.

#### Logistic Regression
In order to conduct a logistic regression using sleep quality as a dependent variable, we need to first convert it to a dichotomous variable. Let's consider that "Very Bad" and "Bad" are failures and "Fair", "Good" and "Very Good" are successes.

```{r}

PPCRdata %>% mutate (sleepqualitydich = case_when(
                        sleepquality %in% c("Very bad", "Bad") ~ 0,
                        sleepquality %in% c("Fair", "Good", "Very good") ~ 1
                                                )
                     ) -> PPCRdata

head(PPCRdata$sleepqualitydich)
summary(PPCRdata$sleepqualitydich)

```

##### Unadjusted Analysis
Let's proceed with the unadjusted analysis with sleepquality as a dichotomous variable.

```{r, warning = FALSE}

model7 <- glm(sleepqualitydich ~ pain, "binomial", data = PPCRdata)
summary(model7)

## creating and saving table for publication
tbl_pub (model7, tablePath, "model7.docx", labelList[2]) -> tbl7

model7Tidy <- tidy(model7, conf.int = TRUE, exponentiate = TRUE)
model7Tidy %>% rename(Odds.Ratio = estimate) -> model7Tidy
model7Tidy

model7Tidy %>% ggplot (aes(Odds.Ratio, term, xmin = conf.low,
                           xmax = conf.high, height = 0)) +
                ## inserting a point for the odds ratio
                geom_point() +
                ## drawing a line at the 1 to improve readability
                geom_vline(xintercept = 1, lty = 4) +
                ## drawing an horizontal line to represent the 
                ## confidence interval
                geom_errorbarh() +
                scale_y_discrete(
                        limits = setdiff(model7Tidy$term, "(Intercept)"))

```

The presence of pain is associated with decreased odds of a success in sleep quality that is "Fair" or better.

##### Adjusted Analysis

```{r, warning = FALSE}

model8 <- glm(sleepqualitydich ~ pain + age + bmi + depression + alcohol +
                      fracture + cancer + diabetes + dementia + arthritis +
                      heartdisease + lungdisease, "binomial", data = PPCRdata)
summary(model8)

## creating and saving table for publication
tbl_pub (model8, tablePath, "model8.docx", labelList[-c(1,14)]) -> tbl8

## creating merged table for adjusted and unadjusted analysis together
tbl_merge(list(tbl7,tbl8),
          tab_spanner = c("**Unadjusted**", "**Adjusted**")) -> merged2

if(!file.exists(paste(tablePath,"merged2.docx", sep=""))){
        merged2 %>% as_gt() %>% gt::gtsave(filename = "merged2.docx", path = tablePath)
}

## creating a table that has the four models together
tbl_merge(list(merged1,merged2)) %>%
        as_gt() %>% gt::tab_spanner(label = gt::md("**Unadjusted**"),
                                    columns = matches("_1_1"),
                                    replace = TRUE,
                                    level = 1,
                                    id = "unadjusted1") %>%
        gt::tab_spanner(label = gt::md("**Adjusted**"),
                        columns = matches("_2_1"),
                        replace = TRUE,
                        level = 1,
                        id = "adjusted1") %>%
        gt::tab_spanner(label = gt::md("**Unadjusted**"),
                                    columns = matches("_1_2"),
                                    replace = TRUE,
                                    level = 1,
                                    id = "unadjusted2") %>%
        gt::tab_spanner(label = gt::md("**Adjusted**"),
                        columns = matches("_2_2"),
                        replace = TRUE,
                        level = 1,
                        id = "adjusted2") %>%
        gt::tab_spanner(label = gt::md("**Outcome: Pain**"),
                        spanners = c("unadjusted1","adjusted1"),
                        level = 2) %>%
        gt::tab_spanner(label = gt::md("**Outcome: Sleep Quality**"),
                        spanners = c("unadjusted2", "adjusted2"),
                        level = 2) -> merged3 

if(!file.exists(paste(tablePath,"merged3.docx", sep=""))){
        merged3 %>% gt::gtsave(filename = "merged3.docx", path = tablePath)
}

merged3

model8Tidy <- tidy(model8, conf.int = TRUE, exponentiate = TRUE)
model8Tidy %>% rename(Odds.Ratio = estimate) -> model8Tidy
model8Tidy

## adding the reference terms to the data frame to allow for a better plot
model8Tidy %>% 
        add_row(term = "alcoholNever", Odds.Ratio = -99, std.error = 0, statistic = 0, p.value = 0, conf.low = 0, conf.high = 0, .before = 10) %>%
        ## filtering the intercept
        filter (term !="(Intercept)") %>%
        ## saving the result so that we can refer to it in the next call
        {. ->> model8Tidy}%>%
        ## adding a variable to determine whether the observation
        ## is a reference or not. Initially adding everything as FALSE
        add_column(.after = "conf.high",
                   reference = rep(FALSE, length.out = nrow(model8Tidy))) %>%
        ## now the appropriate ones to TRUE
        dplyr::mutate(reference = case_when
               (term %in% c("Never") ~ TRUE,
                                     TRUE ~ FALSE)) %>%
        ## create a Variable column
        dplyr::mutate(.after= "term",
                      Variable = case_when(grepl("pain", term) ~ "Pain",
                                           grepl("age", term) ~ "Age",
                                           grepl("bmi", term) ~ "Body Mass Index",
                                           grepl("depression",term) ~ "Depression",
                                           grepl("alcohol",term) ~ "Alcohol",
                                           grepl("fracture", term) ~ "Fracture",
                                           grepl("cancer",term) ~ "Cancer",
                                           grepl("diabetes",term) ~ "Diabetes",
                                           grepl("dementia", term) ~ "Dementia",
                                           grepl("arthritis",term) ~ "Arthritis",
                                           grepl("heart",term) ~ "Heart Disease",
                                           grepl("lung",term) ~ "Lung Disease")) %>%
        ## transform the variables to factor
        dplyr::mutate(Variable = as_factor(Variable)) %>%
        dplyr::mutate(term = as_factor(term)) -> model8Tidy


model8Tidy %>% ggplot (aes(x = Odds.Ratio, y = term, xmin = conf.low,
                           xmax = conf.high, height = 0, alpha = !reference)) +
                ## inserting a point for the odds ratio
                geom_point(aes(alpha = !reference)) +
                ## drawing a line at the 1 to improve readability
                geom_vline(xintercept = 1, lty = 4) +
                ## drawing an horizontal line to represent the 
                ## confidence interval
                geom_errorbarh() +
                scale_y_discrete(labels = labels2) +
                labs(x = "Odds Ratio", y = "",
                     title = "Sleep Quality being Fair or Better", 
                subtitle = "Adjusted Odds Ratios",
                caption = paste("N =", nobs(model8))) +
                facet_grid(Variable ~ ., scales = "free_y", space = "free_y") +
                scale_alpha_identity() +
                # hide facet labels
                theme(strip.background = element_blank(),
                strip.text = element_blank()) +
                # remove spacing between facets
                theme(panel.spacing = unit(0, "pt")) +
                scale_x_continuous(breaks = seq(0,1.8, by = 0.2),
                                   limits = (c(0.3,1.53))) -> plot8

## checking if plot has been saved already
if (!file.exists("C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots/plot8.png")){
        ## if it hasn't, saving the plot for publication
        ggsave("plot8.png", plot8, 
               path = "C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots") 
}

plot8

```

##### Testing the assumptions


##### Sensitivity Analysis
###### Inclusion of Sex as a Covariate
The analysis done by Morelhão et al. didn't include sex as a covariate. We can analyze with it included to see its effect.

```{r, warning = FALSE}

model9 <- glm(sleepqualitydich ~ pain + age + bmi + depression + alcohol +
         fracture + cancer + diabetes + dementia + arthritis +
         heartdisease + lungdisease + sex, "binomial", data = PPCRdata)

model9 %>% tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
        rename(Odds.Ratio = estimate) -> model9Tidy

model9Tidy

## creating and saving table for publication
tbl_pub (model9, tablePath, "model9.docx", labelList[-1])

## adding the reference terms to the data frame to allow for a better plot
model9Tidy %>% 
        add_row(term = "alcoholNever", Odds.Ratio = 0, std.error = 0, statistic = 0, p.value = 0, conf.low = 0, conf.high = 0, .before = 10) %>%
        ## filtering the intercept
        filter (term !="(Intercept)") %>%
        ## saving the result so that we can refer to it in the next call
        {. ->> model9Tidy}%>%
        ## adding a variable to determine whether the observation
        ## is a reference or not. Initially adding everything as FALSE
        add_column(.after = "conf.high",
                   reference = rep(FALSE, length.out = nrow(model9Tidy))) %>%
        ## now the appropriate ones to TRUE
        dplyr::mutate(reference = case_when
               (term %in% c("alcoholNever") ~ TRUE,
                                     TRUE ~ FALSE)) %>%
        ## create a Variable column
        dplyr::mutate(.after= "term",
                      Variable = case_when(grepl("pain", term) ~ "Pain",
                                           grepl("age", term) ~ "Age",
                                           grepl("bmi", term) ~ "Body Mass Index",
                                           grepl("depression",term) ~ "Depression",
                                           grepl("alcohol",term) ~ "Alcohol",
                                           grepl("fracture", term) ~ "Fracture",
                                           grepl("cancer",term) ~ "Cancer",
                                           grepl("diabetes",term) ~ "Diabetes",
                                           grepl("dementia", term) ~ "Dementia",
                                           grepl("arthritis",term) ~ "Arthritis",
                                           grepl("heart",term) ~ "Heart Disease",
                                           grepl("lung",term) ~ "Lung Disease",
                                           grepl("sex",term) ~ "Sex")) %>%
        ## transform the variables to factor
        dplyr::mutate(Variable = as_factor(Variable)) %>%
        dplyr::mutate(term = as_factor(term)) -> model9Tidy

model9Tidy %>% ggplot (aes(x = Odds.Ratio, y = term, xmin = conf.low,
                           xmax = conf.high, height = 0, alpha = !reference)) +
                ## inserting a point for the odds ratio
                geom_point(aes(alpha = !reference)) +
                ## drawing a line at the 1 to improve readability
                geom_vline(xintercept = 1, lty = 4) +
                ## drawing an horizontal line to represent the 
                ## confidence interval
                geom_errorbarh() +
                scale_y_discrete(labels = labels2) +
                labs(x = "Odds Ratio", y = "",
                     title = "Sleep Quality being Fair or Better", 
                subtitle = "Adjusted Odds Ratios",
                caption = paste("N =", nobs(model3))) +
                facet_grid(Variable ~ ., scales = "free_y", space = "free_y") +
                scale_alpha_identity() +
                # hide facet labels
                theme(strip.background = element_blank(),
                strip.text = element_blank()) +
                # remove spacing between facets
                theme(panel.spacing = unit(0, "pt")) +
                scale_x_continuous(breaks = seq(0,1.8, by = 0.2),
                                   limits = (c(0.3,1.67))) -> plot9

## checking if plot has been saved already
if (!file.exists("C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots/plot9.png")){
        ## if it hasn't, saving the plot for publication
        ggsave("plot9.png", plot9, 
               path = "C:/Users/Pedro Henrique/Documents/PPCR/Data Analysis Project/DataProjectPPCR/plots") 
}

plot9


```

The results show us that being male is associated with increased odds of having fair or better sleep quality.

###### Replacing Individual Comorbidities with a Self-Reported General Health Assessment

We can also substitute the usage of variables to determine presence of comorbidities for a general health assessment reported by the patient himself, to see if it changes the analysis.

```{r}
# modeling
model10 <- glm(sleepqualitydich ~ pain + genhealth + age + bmi + sex, "binomial", data = PPCRdata)

model10 %>% tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
        rename(Odds.Ratio = estimate) -> model10Tidy

tbl_pub (model10, tablePath, "model10.docx",
         append(labelList[-c(1,5,6,7,8,9,10,11,12,13)], genhealth ~ "General Health Assessment"))
```

While the direction of the effect was the same, when considering the subjects perception of their own general health status instead of comorbidity level, the presence of pain has a lower effect size in the association of decreased odds of having sleep quality that is fair or better.

###### Evaluation of dose-effect relationship between pain and sleep quality

We can also take a look at the subset of patients that have pain to see if sleep quality is worse with increasing levels of pain.

```{r}
## unadjusted
model11 <- glm(sleepqualitydich ~ p_intensity,
               data = filter(PPCRdata, pain == "Yes"), family = "binomial")

model11 %>% tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
        rename(Odds.Ratio = estimate) -> model11Tidy

tbl_pub(model11, tablePath, "model11.docx",
        list(p_intensity ~ "Pain Intensity")) -> tbl11

## adjusted
model12 <- glm(sleepqualitydich ~ p_intensity + age + bmi + sex + depression + alcohol +
         fracture + cancer + diabetes + dementia + arthritis +
         heartdisease + lungdisease,
    data = filter(PPCRdata, pain == "Yes"),
    family = "binomial")

model12 %>% tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
        rename(Odds.Ratio = estimate) -> model12Tidy

tbl_pub (model12, tablePath, "model12.docx",
         append(labelList[-c(1,2)], p_intensity ~ "Pain Intensity")) -> tbl12

tbl_merge(list(tbl11,tbl12),
          tab_spanner = c("**Unadjusted**", "**Adjusted**")) -> merged4

if(!file.exists(paste(tablePath,"merged4.docx", sep=""))){
        merged4 %>% as_gt() %>% gt::gtsave(filename = "merged4.docx", path = tablePath)
}

merged4

```

Increasing levels of pain intensity are also associated with decreased odds of having fair or better sleep quality.